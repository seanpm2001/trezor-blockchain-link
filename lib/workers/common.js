"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.clearSubscriptions = exports.removeSubscription = exports.getSubscription = exports.addSubscription = exports.removeAddresses = exports.getAddresses = exports.addAddresses = exports.response = exports.errorHandler = exports.handshake = exports.debug = exports.getSettings = exports.setSettings = void 0;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _constants = require("../constants");

/* @flow */
var _settings;

var _debugPrefix;

var _addresses = [];
var _subscription = {};

var setSettings = function setSettings(s) {
  _settings = s;
  _debugPrefix = "[Worker \"".concat(s.name, "\"]:");
};

exports.setSettings = setSettings;

var getSettings = function getSettings() {
  return _settings;
};

exports.getSettings = getSettings;

var debug = function debug() {
  if (_settings && _settings.debug) {
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    if (args[0] === 'warn' || args[0] === 'error') {
      var _console;

      (_console = console)[args[0]].apply(_console, [_debugPrefix].concat((0, _toConsumableArray2.default)(args.slice(1))));
    } else {
      var _console2;

      (_console2 = console).log.apply(_console2, [_debugPrefix].concat(args));
    }
  }
};

exports.debug = debug;

var handshake = function handshake() {
  postMessage({
    id: -1,
    type: _constants.MESSAGES.HANDSHAKE
  });
};

exports.handshake = handshake;

var errorHandler = function errorHandler(_ref) {
  var id = _ref.id,
      error = _ref.error;
  var message = '';

  if (typeof error === 'string') {
    message = error;
  } else if ((0, _typeof2.default)(error) === 'object') {
    var keys = Object.keys(error);

    if (keys.indexOf('name') >= 0) {
      message = error.name;
    } else {
      message = error.message;
    }
  }

  postMessage({
    id: id,
    type: _constants.RESPONSES.ERROR,
    payload: message
  });
};

exports.errorHandler = errorHandler;

var response = function response(data) {
  postMessage(data);
};

exports.response = response;

var getUniqueInput = function getUniqueInput(addresses) {
  if (!Array.isArray(addresses)) return [];
  var seen = {};
  return addresses.filter(function (a) {
    if (typeof a !== 'string') return false;
    return seen.hasOwnProperty(a) ? false : seen[a] = true;
  });
};

var addAddresses = function addAddresses(addresses) {
  var unique = getUniqueInput(addresses).filter(function (a) {
    return _addresses.indexOf(a) < 0;
  });
  _addresses = _addresses.concat(unique);
  return unique;
};

exports.addAddresses = addAddresses;

var getAddresses = function getAddresses() {
  return _addresses;
};

exports.getAddresses = getAddresses;

var removeAddresses = function removeAddresses(addresses) {
  var unique = getUniqueInput(addresses);
  _addresses = _addresses.filter(function (a) {
    return unique.indexOf(a) < 0;
  });
  return _addresses;
};

exports.removeAddresses = removeAddresses;

var addSubscription = function addSubscription(type) {
  _subscription[type] = true;
};

exports.addSubscription = addSubscription;

var getSubscription = function getSubscription(type) {
  return _subscription[type];
};

exports.getSubscription = getSubscription;

var removeSubscription = function removeSubscription(type) {
  delete _subscription[type];
};

exports.removeSubscription = removeSubscription;

var clearSubscriptions = function clearSubscriptions() {
  Object.keys(_subscription).forEach(function (key) {
    return _subscription[key] = false;
  });
};

exports.clearSubscriptions = clearSubscriptions;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93b3JrZXJzL2NvbW1vbi50cyJdLCJuYW1lcyI6WyJfc2V0dGluZ3MiLCJfZGVidWdQcmVmaXgiLCJfYWRkcmVzc2VzIiwiX3N1YnNjcmlwdGlvbiIsInNldFNldHRpbmdzIiwicyIsIm5hbWUiLCJnZXRTZXR0aW5ncyIsImRlYnVnIiwiYXJncyIsImNvbnNvbGUiLCJzbGljZSIsImxvZyIsImhhbmRzaGFrZSIsInBvc3RNZXNzYWdlIiwiaWQiLCJ0eXBlIiwiTUVTU0FHRVMiLCJIQU5EU0hBS0UiLCJlcnJvckhhbmRsZXIiLCJlcnJvciIsIm1lc3NhZ2UiLCJrZXlzIiwiT2JqZWN0IiwiaW5kZXhPZiIsIlJFU1BPTlNFUyIsIkVSUk9SIiwicGF5bG9hZCIsInJlc3BvbnNlIiwiZGF0YSIsImdldFVuaXF1ZUlucHV0IiwiYWRkcmVzc2VzIiwiQXJyYXkiLCJpc0FycmF5Iiwic2VlbiIsImZpbHRlciIsImEiLCJoYXNPd25Qcm9wZXJ0eSIsImFkZEFkZHJlc3NlcyIsInVuaXF1ZSIsImNvbmNhdCIsImdldEFkZHJlc3NlcyIsInJlbW92ZUFkZHJlc3NlcyIsImFkZFN1YnNjcmlwdGlvbiIsImdldFN1YnNjcmlwdGlvbiIsInJlbW92ZVN1YnNjcmlwdGlvbiIsImNsZWFyU3Vic2NyaXB0aW9ucyIsImZvckVhY2giLCJrZXkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFGQTtBQU1BLElBQUlBLFNBQUo7O0FBQ0EsSUFBSUMsWUFBSjs7QUFDQSxJQUFJQyxVQUF5QixHQUFHLEVBQWhDO0FBQ0EsSUFBTUMsYUFBdUMsR0FBRyxFQUFoRDs7QUFFTyxJQUFNQyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFDQyxDQUFELEVBQWlDO0FBQ3hETCxFQUFBQSxTQUFTLEdBQUdLLENBQVo7QUFDQUosRUFBQUEsWUFBWSx1QkFBZUksQ0FBQyxDQUFDQyxJQUFqQixTQUFaO0FBQ0gsQ0FITTs7OztBQUtBLElBQU1DLFdBQVcsR0FBRyxTQUFk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QUFBLFdBQUk3QyxhQUFhLENBQUM2QyxHQUFELENBQWIsR0FBcUIsS0FBekI7QUFBQSxHQUF0QztBQUNILENBRk0iLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgeyBNRVNTQUdFUywgUkVTUE9OU0VTIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcblxuZGVjbGFyZSBmdW5jdGlvbiBwb3N0TWVzc2FnZShkYXRhOiBSZXNwb25zZSk6IHZvaWQ7XG5cbmxldCBfc2V0dGluZ3M6IEJsb2NrY2hhaW5TZXR0aW5ncztcbmxldCBfZGVidWdQcmVmaXg6IHN0cmluZztcbmxldCBfYWRkcmVzc2VzOiBBcnJheTxzdHJpbmc+ID0gW107XG5jb25zdCBfc3Vic2NyaXB0aW9uOiB7W2tleTogc3RyaW5nXTogYm9vbGVhbn0gPSB7fTtcblxuZXhwb3J0IGNvbnN0IHNldFNldHRpbmdzID0gKHM6IEJsb2NrY2hhaW5TZXR0aW5ncyk6IHZvaWQgPT4ge1xuICAgIF9zZXR0aW5ncyA9IHM7XG4gICAgX2RlYnVnUHJlZml4ID0gYFtXb3JrZXIgXCIke3MubmFtZX1cIl06YDtcbn1cblxuZXhwb3J0IGNvbnN0IGdldFNldHRpbmdzID0gKCk6IEJsb2NrY2hhaW5TZXR0aW5ncyA9PiB7XG4gICAgcmV0dXJuIF9zZXR0aW5ncztcbn1cblxuZXhwb3J0IGNvbnN0IGRlYnVnID0gKC4uLmFyZ3M6IEFycmF5PGFueT4pOiB2b2lkID0+IHtcbiAgICBpZiAoX3NldHRpbmdzICYmIF9zZXR0aW5ncy5kZWJ1Zykge1xuICAgICAgICBpZiAoYXJnc1swXSA9PT0gJ3dhcm4nIHx8IGFyZ3NbMF0gPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgIGNvbnNvbGVbYXJnc1swXV0oX2RlYnVnUHJlZml4LCAuLi5hcmdzLnNsaWNlKDEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKF9kZWJ1Z1ByZWZpeCwgLi4uYXJncylcbiAgICAgICAgfVxuICAgIH1cbn0gXG5cbmV4cG9ydCBjb25zdCBoYW5kc2hha2UgPSAoKTogdm9pZCA9PiB7XG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICBpZDogLTEsXG4gICAgICAgIHR5cGU6IE1FU1NBR0VTLkhBTkRTSEFLRSxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IGVycm9ySGFuZGxlciA9ICh7IGlkLCBlcnJvciB9OiB7IGlkOiBudW1iZXIsIGVycm9yOiBPYmplY3R9KTogdm9pZCA9PiB7XG4gICAgbGV0IG1lc3NhZ2U6IHN0cmluZyA9ICcnO1xuICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIG1lc3NhZ2UgPSBlcnJvcjtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGVycm9yKTtcbiAgICAgICAgaWYgKGtleXMuaW5kZXhPZignbmFtZScpID49IDApIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBlcnJvci5uYW1lO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcG9zdE1lc3NhZ2Uoe1xuICAgICAgICBpZCxcbiAgICAgICAgdHlwZTogUkVTUE9OU0VTLkVSUk9SLFxuICAgICAgICBwYXlsb2FkOiBtZXNzYWdlXG4gICAgfSk7XG59XG5cbmV4cG9ydCBjb25zdCByZXNwb25zZSA9IChkYXRhOiBSZXNwb25zZSk6IHZvaWQgPT4ge1xuICAgIHBvc3RNZXNzYWdlKGRhdGEpO1xufTtcblxuY29uc3QgZ2V0VW5pcXVlSW5wdXQgPSAoYWRkcmVzc2VzOiBBcnJheTxzdHJpbmc+KTogQXJyYXk8c3RyaW5nPiA9PiB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGFkZHJlc3NlcykpIHJldHVybiBbXTtcbiAgICBjb25zdCBzZWVuID0ge307XG4gICAgcmV0dXJuIGFkZHJlc3Nlcy5maWx0ZXIoYSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2YgYSAhPT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIChzZWVuLmhhc093blByb3BlcnR5KGEpID8gZmFsc2UgOiAoc2VlblthXSA9IHRydWUpKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IGFkZEFkZHJlc3NlcyA9IChhZGRyZXNzZXM6IEFycmF5PHN0cmluZz4pOiBBcnJheTxzdHJpbmc+ID0+IHtcbiAgICBjb25zdCB1bmlxdWUgPSBnZXRVbmlxdWVJbnB1dChhZGRyZXNzZXMpLmZpbHRlcihhID0+IF9hZGRyZXNzZXMuaW5kZXhPZihhKSA8IDApO1xuICAgIF9hZGRyZXNzZXMgPSBfYWRkcmVzc2VzLmNvbmNhdCh1bmlxdWUpO1xuICAgIHJldHVybiB1bmlxdWU7XG59XG5cbmV4cG9ydCBjb25zdCBnZXRBZGRyZXNzZXMgPSAoKTogQXJyYXk8c3RyaW5nPiA9PiB7XG4gICAgcmV0dXJuIF9hZGRyZXNzZXM7XG59XG5cbmV4cG9ydCBjb25zdCByZW1vdmVBZGRyZXNzZXMgPSAoYWRkcmVzc2VzOiBBcnJheTxzdHJpbmc+KTogQXJyYXk8c3RyaW5nPiA9PiB7XG4gICAgY29uc3QgdW5pcXVlID0gZ2V0VW5pcXVlSW5wdXQoYWRkcmVzc2VzKTtcbiAgICBfYWRkcmVzc2VzID0gX2FkZHJlc3Nlcy5maWx0ZXIoYSA9PiB1bmlxdWUuaW5kZXhPZihhKSA8IDApO1xuICAgIHJldHVybiBfYWRkcmVzc2VzO1xufVxuXG5leHBvcnQgY29uc3QgYWRkU3Vic2NyaXB0aW9uID0gKHR5cGU6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgIF9zdWJzY3JpcHRpb25bdHlwZV0gPSB0cnVlO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFN1YnNjcmlwdGlvbiA9ICh0eXBlOiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgICByZXR1cm4gX3N1YnNjcmlwdGlvblt0eXBlXTtcbn07XG5cbmV4cG9ydCBjb25zdCByZW1vdmVTdWJzY3JpcHRpb24gPSAodHlwZTogc3RyaW5nKTogdm9pZCA9PiB7XG4gICAgZGVsZXRlIF9zdWJzY3JpcHRpb25bdHlwZV07XG59O1xuXG5leHBvcnQgY29uc3QgY2xlYXJTdWJzY3JpcHRpb25zID0gKCk6IHZvaWQgPT4ge1xuICAgIE9iamVjdC5rZXlzKF9zdWJzY3JpcHRpb24pLmZvckVhY2goa2V5ID0+IF9zdWJzY3JpcHRpb25ba2V5XSA9IGZhbHNlKTtcbn07Il19